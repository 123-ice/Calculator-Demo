#
# Release
# This pipeline builds a version of the app in a production configuration to be released to the
# Store and the Windows image. This pipeline relies on Microsoft-internal resources to run.
#

trigger: none
pr: none

variables:
  versionMajor: 0
  versionMinor: 2404
  versionBuild: $[counter(format('{0}.{1}.*', variables['versionMajor'], variables['versionMinor']), 0)]
  versionPatch: 0

name: '$(versionMajor).$(versionMinor).$(versionBuild).$(versionPatch)'

parameters:
  buildPlatformList: [x64, x86, ARM, ARM64]
  testPlatformList: [x64, x86]

resources:
  repositories:
  - repository: 1esPipelines
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/release

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1esPipelines
  parameters:
    pool:
      name: EssentialExperiences-windows-2022
      image: MMSWindows2022-Secure
      os: windows

    stages:
    - stage: BuildStage
      jobs:
      - ${{ each platform in parameters.buildPlatformList }}:
        - template: /build/pipelines/templates/build-single-architecture.yaml@self
          parameters:
            platform: ${{ platform }}
            isReleaseBuild: true
            useReleaseAppxmanifest: true

    - stage: UnitTestStage
      dependsOn: BuildStage
      jobs:
      - ${{ each platform in parameters.testPlatformList }}:
        - template: /build/pipelines/templates/run-unit-tests.yaml@self
          parameters:
            platform: ${{ platform }}

    - stage: UiTestStage
      dependsOn: BuildStage
      jobs:
      - ${{ each platform in parameters.testPlatformList }}:
        - template: /build/pipelines/templates/run-ui-tests.yaml@self
          parameters:
            platform: ${{ platform }}
            runsettingsFileName: CalculatorUITests.release.runsettings

    - stage: PackageStage
      dependsOn: [UnitTestStage, UiTestStage]
      jobs:
      - template: /build/pipelines/templates/package-msixbundle.yaml@self
        parameters:
          signBundle: true
          createStoreBrokerPackages: true

    - stage: PublishStage
      dependsOn: PackageStage
      jobs:
      - template: /build/pipelines/templates/release-store.yaml@self
      - template: /build/pipelines/templates/release-vpack.yaml@self
